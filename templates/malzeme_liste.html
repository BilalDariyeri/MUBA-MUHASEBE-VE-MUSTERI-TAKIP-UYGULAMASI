<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malzemeler Modülü</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cari_hesap_liste.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/input-fix.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Üst Menü Çubuğu -->
        {% include 'includes/header.html' %}

        <!-- Ana İçerik Alanı -->
        <main class="main-content">
            <div class="cari-modul-header">
                <h2 class="modul-title">Malzemeler</h2>
                <button class="btn-yeni-cari" onclick="showAddMalzemeDialog()">
                    <i class="fas fa-plus"></i>
                    Yeni Malzeme Ekle
                </button>
            </div>

            <!-- Arama Çubuğu -->
            <div class="search-section" style="margin: 20px 0;">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="malzeme-search" placeholder="Malzeme kodu veya ad ile ara..." class="search-input" onkeyup="filterMalzemeler()">
                </div>
            </div>

            <!-- Malzeme Tablosu -->
            <div class="cari-table-container">
                <div id="loading" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                </div>
                <div class="table-wrapper">
                    <table class="cari-table" id="malzeme-table">
                        <thead>
                            <tr>
                                <th>Kod</th>
                                <th>Malzeme Adı</th>
                                <th>Birim</th>
                                <th>Stok</th>
                                <th>Birim Fiyat (₺)</th>
                                <th>KDV %</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="malzeme-tbody">
                            <!-- Veriler JavaScript ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Yeni Malzeme Ekleme/Düzenleme Dialog -->
    <div id="add-malzeme-dialog" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="malzeme-dialog-title">Yeni Malzeme Ekle</h3>
                <span class="modal-close" onclick="closeAddMalzemeDialog()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="malzeme-form">
                <input type="hidden" id="malzeme-id" value="">
                <div class="form-group-modal">
                    <label for="malzeme-kod">Malzeme Kodu:</label>
                    <input type="text" id="malzeme-kod" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <small style="color: #666;">Boş bırakılırsa otomatik oluşturulur</small>
                </div>
                <div class="form-group-modal">
                    <label for="malzeme-ad">Malzeme Adı *:</label>
                    <input type="text" id="malzeme-ad" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group-modal">
                    <label for="malzeme-birim">Birim *:</label>
                    <select id="malzeme-birim" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="ADET">ADET</option>
                        <option value="Kg">Kg</option>
                        <option value="Ton">Ton</option>
                        <option value="Litre">Litre</option>
                        <option value="Metre">Metre</option>
                        <option value="m²">m²</option>
                        <option value="m³">m³</option>
                    </select>
                </div>
                <div class="form-group-modal">
                    <label for="malzeme-stok">Stok:</label>
                    <input type="number" id="malzeme-stok" step="0.01" value="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group-modal">
                    <label for="malzeme-birim-fiyat">Birim Fiyat:</label>
                    <input type="number" id="malzeme-birim-fiyat" step="0.01" value="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group-modal">
                    <label for="malzeme-kdv">KDV %:</label>
                    <input type="number" id="malzeme-kdv" value="18" min="0" max="100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group-modal">
                    <label for="malzeme-aciklama">Açıklama:</label>
                    <textarea id="malzeme-aciklama" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" onclick="closeAddMalzemeDialog()">İptal</button>
                <button type="submit" form="malzeme-form" class="btn-modal-save" id="malzeme-save-btn">Kaydet</button>
            </div>
        </div>
    </div>

    <script>
        let malzemeler = [];

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            loadMalzemeler();
            checkAdminAndShowDeleteButtons();
        });
        
        // Admin kontrolü ve silme butonlarını göster
        async function checkAdminAndShowDeleteButtons() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();
                
                if (data.success && data.user && data.user.is_admin) {
                    // Admin ise tüm silme butonlarını göster
                    document.querySelectorAll('[id^="delete-malzeme-btn-"]').forEach(btn => {
                        btn.style.display = 'inline-block';
                    });
                }
            } catch (error) {
                console.error('Admin kontrolü hatası:', error);
            }
        }

        // Malzemeleri yükle
        async function loadMalzemeler() {
            try {
                document.getElementById('loading').style.display = 'block';
                const response = await fetch('/api/malzeme');
                const data = await response.json();
                
                if (data.success) {
                    malzemeler = data.malzemeler || [];
                    displayMalzemeler(malzemeler);
                } else {
                    NotificationSystem.error('Malzemeler yüklenirken hata oluştu: ' + data.error, true);
                }
            } catch (error) {
                console.error('Hata:', error);
                NotificationSystem.error('Malzemeler yüklenirken hata oluştu', true);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Malzemeleri göster
        function displayMalzemeler(malzemeList) {
            const tbody = document.getElementById('malzeme-tbody');
            tbody.innerHTML = '';

            if (malzemeList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Henüz malzeme eklenmemiş</td></tr>';
                return;
            }

            malzemeList.forEach(malzeme => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${malzeme.kod || '-'}</td>
                    <td>${malzeme.ad || '-'}</td>
                    <td>${malzeme.birim || '-'}</td>
                    <td>${formatNumber(malzeme.stok || 0)}</td>
                    <td>${formatCurrency(malzeme.birimFiyat || 0)}</td>
                    <td>%${malzeme.kdvOrani || 0}</td>
                    <td>
                        <button onclick="editMalzeme('${malzeme.id}')" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                            <i class="fas fa-edit"></i> Düzenle
                        </button>
                        <button id="delete-malzeme-btn-${malzeme.id}" onclick="deleteMalzeme('${malzeme.id}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; display: none;">
                            <i class="fas fa-trash"></i> Sil
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Admin kontrolü yap ve silme butonlarını göster
            checkAdminAndShowDeleteButtons();
        }

        // Filtreleme
        function filterMalzemeler() {
            const searchTerm = document.getElementById('malzeme-search').value.toLowerCase();
            const filtered = malzemeler.filter(m => {
                const kod = (m.kod || '').toLowerCase();
                const ad = (m.ad || '').toLowerCase();
                return kod.includes(searchTerm) || ad.includes(searchTerm);
            });
            displayMalzemeler(filtered);
        }

        // Dialog işlemleri
        function showAddMalzemeDialog() {
            document.getElementById('malzeme-dialog-title').textContent = 'Yeni Malzeme Ekle';
            document.getElementById('malzeme-save-btn').textContent = 'Kaydet';
            document.getElementById('malzeme-id').value = '';
            document.getElementById('malzeme-form').reset();
            document.getElementById('malzeme-kod').disabled = false;
            document.getElementById('add-malzeme-dialog').style.display = 'block';
        }

        function closeAddMalzemeDialog() {
            document.getElementById('add-malzeme-dialog').style.display = 'none';
            document.getElementById('malzeme-form').reset();
            document.getElementById('malzeme-id').value = '';
        }

        // Form gönderimi
        document.getElementById('malzeme-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const malzemeId = document.getElementById('malzeme-id').value;
            const isEdit = malzemeId !== '';
            
            const malzemeData = {
                ad: document.getElementById('malzeme-ad').value,
                birim: document.getElementById('malzeme-birim').value,
                stok: parseFloat(document.getElementById('malzeme-stok').value) || 0,
                birimFiyat: parseFloat(document.getElementById('malzeme-birim-fiyat').value) || 0,
                kdvOrani: parseInt(document.getElementById('malzeme-kdv').value) || 18,
                aciklama: document.getElementById('malzeme-aciklama').value
            };

            // Kod ekle (sadece yeni eklemede veya düzenlemede kod değiştiriliyorsa)
            const kod = document.getElementById('malzeme-kod').value.trim();
            if (kod) {
                malzemeData.kod = kod.toUpperCase();
            }

            try {
                let url = '/api/malzeme';
                let method = 'POST';
                
                if (isEdit) {
                    url = `/api/malzeme/${malzemeId}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(malzemeData)
                });

                const data = await response.json();
                
                if (data.success) {
                    NotificationSystem.success(isEdit ? 'Malzeme başarıyla güncellendi!' : 'Malzeme başarıyla eklendi!', false);
                    closeAddMalzemeDialog();
                    loadMalzemeler();
                } else {
                    NotificationSystem.error('Hata: ' + data.error, true);
                }
            } catch (error) {
                console.error('Hata:', error);
                NotificationSystem.error(isEdit ? 'Malzeme güncellenirken hata oluştu' : 'Malzeme eklenirken hata oluştu', true);
            }
        });

        function editMalzeme(id) {
            const malzeme = malzemeler.find(m => m.id === id);
            if (!malzeme) {
                NotificationSystem.error('Malzeme bulunamadı', true);
                return;
            }

            // Dialog'u düzenleme moduna al
            document.getElementById('malzeme-dialog-title').textContent = 'Malzeme Düzenle';
            document.getElementById('malzeme-save-btn').textContent = 'Güncelle';
            document.getElementById('malzeme-id').value = malzeme.id;
            
            // Form alanlarını doldur
            document.getElementById('malzeme-kod').value = malzeme.kod || '';
            document.getElementById('malzeme-kod').disabled = true; // Kod düzenlenemez
            document.getElementById('malzeme-ad').value = malzeme.ad || '';
            document.getElementById('malzeme-birim').value = malzeme.birim || 'ADET';
            document.getElementById('malzeme-stok').value = malzeme.stok || 0;
            document.getElementById('malzeme-birim-fiyat').value = malzeme.birimFiyat || 0;
            document.getElementById('malzeme-kdv').value = malzeme.kdvOrani || 18;
            document.getElementById('malzeme-aciklama').value = malzeme.aciklama || '';
            
            // Dialog'u göster
            document.getElementById('add-malzeme-dialog').style.display = 'block';
        }

        async function deleteMalzeme(id) {
            // Admin kontrolü
            try {
                const userResponse = await fetch('/api/auth/me');
                const userData = await userResponse.json();
                
                if (!userData.success || !userData.user || !userData.user.is_admin) {
                    NotificationSystem.error('Bu işlem için admin yetkisi gereklidir!', true);
                    return;
                }
            } catch (error) {
                NotificationSystem.error('Yetki kontrolü yapılamadı!', true);
                return;
            }
            
            const malzeme = malzemeler.find(m => m.id === id);
            if (!malzeme) {
                NotificationSystem.error('Malzeme bulunamadı', true);
                return;
            }

            const details = [
                { label: 'Kod', value: malzeme.kod || '-' },
                { label: 'Malzeme Adı', value: malzeme.ad || '-' },
                { label: 'Birim', value: malzeme.birim || '-' },
                { label: 'Stok', value: formatNumber(malzeme.stok || 0) },
                { label: 'Birim Fiyat', value: formatCurrency(malzeme.birimFiyat || 0) }
            ];

            showDeleteModal(
                'Malzemeyi Sil',
                'Bu malzemeyi silmek istediğinize emin misiniz?',
                details,
                async (malzemeId) => {
                    try {
                        const response = await fetch(`/api/malzeme/${malzemeId}`, {
                            method: 'DELETE'
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            NotificationSystem.success('Malzeme başarıyla silindi!', false);
                            loadMalzemeler();
                        } else {
                            NotificationSystem.error('Hata: ' + data.error, true);
                        }
                    } catch (error) {
                        console.error('Hata:', error);
                        NotificationSystem.error('Malzeme silinirken hata oluştu', true);
                    }
                },
                id
            );
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(num);
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(num);
        }

        // Modal dışına tıklanınca kapat
        window.onclick = function(event) {
            const modal = document.getElementById('add-malzeme-dialog');
            if (event.target == modal) {
                closeAddMalzemeDialog();
            }
        }
    </script>
    {% include 'includes/hesap_makinesi.html' %}
    {% include 'includes/notification.html' %}
    {% include 'includes/delete_modal.html' %}
</body>
</html>

