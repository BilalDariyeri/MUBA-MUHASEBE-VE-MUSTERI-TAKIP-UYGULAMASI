<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeni Fatura Ekle</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cari_hesap_liste.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/input-fix.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fatura-form-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .satirlar-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .satirlar-table th,
        .satirlar-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .satirlar-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .btn-add-row {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        .totals-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 16px;
        }
        .totals-row.total {
            font-weight: bold;
            font-size: 20px;
            border-top: 2px solid #667eea;
            padding-top: 15px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        {% include 'includes/header.html' %}

        <main class="main-content">
            <div class="cari-modul-header">
                <h2 class="modul-title">Yeni Fatura Ekle</h2>
                <button class="btn-yeni-cari" onclick="window.location.href='{{ url_for('main.satis_faturalari') }}'">
                    <i class="fas fa-arrow-left"></i> Geri
                </button>
            </div>

            <div class="fatura-form-container">
                <form id="fatura-form">
                    <!-- Fatura Bilgileri -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fatura No:</label>
                            <input type="text" id="fatura-no" readonly style="background: #e9ecef;">
                        </div>
                        <div class="form-group">
                            <label>Tarih *:</label>
                            <input type="date" id="fatura-tarih" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Fatura Tipi:</label>
                            <select id="fatura-tipi">
                                <option value="Satış Faturası">Satış Faturası</option>
                                <option value="İade Faturası">İade Faturası</option>
                                <option value="Proforma">Proforma</option>
                                <option value="e-Fatura">e-Fatura</option>
                                <option value="e-Arşiv">e-Arşiv</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ödeme Planı:</label>
                            <select id="odeme-plani">
                                <option value="Peşin">Peşin</option>
                                <option value="30 Gün" selected>30 Gün</option>
                                <option value="60 Gün">60 Gün</option>
                                <option value="120 Gün">120 Gün</option>
                            </select>
                        </div>
                    </div>

                    <!-- Cari Hesap Seçimi -->
                    <div class="form-group">
                        <label>Cari Hesap *:</label>
                        <select id="cari-hesap" required>
                            <option value="">Cari hesap seçiniz...</option>
                        </select>
                    </div>

                    <!-- Fatura Satırları -->
                    <h3 style="margin-top: 30px;">Fatura Satırları</h3>
                    <button type="button" class="btn-add-row" onclick="addRow()">
                        <i class="fas fa-plus"></i> Satır Ekle
                    </button>
                    <table class="satirlar-table" id="satirlar-table">
                        <thead>
                            <tr>
                                <th>Malzeme Kodu</th>
                                <th>Malzeme Adı</th>
                                <th>Miktar</th>
                                <th>Birim</th>
                                <th>Birim Fiyat</th>
                                <th>KDV %</th>
                                <th>Tutar (KDV Dahil)</th>
                                <th>Toplam</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="satirlar-tbody">
                            <!-- Satırlar buraya eklenecek -->
                        </tbody>
                    </table>

                    <!-- Toplamlar -->
                    <div class="totals-section">
                        <div class="totals-row">
                            <span>Mal / Hizmet Toplam Tutarı (KDV Dahil):</span>
                            <span id="ara-toplam">0,00 ₺</span>
                        </div>
                        <div class="totals-row">
                            <span>Hesaplanan KDV:</span>
                            <span id="kdv-toplam">0,00 ₺</span>
                        </div>
                        <div class="totals-row total">
                            <span>Ödenecek Tutar:</span>
                            <span id="genel-toplam">0,00 ₺</span>
                        </div>
                    </div>

                    <!-- Butonlar -->
                    <div style="margin-top: 30px; text-align: right;">
                        <button type="button" class="btn-modal-cancel" onclick="window.location.href='{{ url_for('main.satis_faturalari') }}'">
                            İptal
                        </button>
                        <button type="submit" class="btn-modal-save">
                            <i class="fas fa-save"></i> Faturayı Kaydet
                        </button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Malzeme datalist (tüm satırlar için ortak) -->
    <datalist id="malzeme-list">
        <!-- JavaScript ile doldurulacak -->
    </datalist>

    <script>
        let cariHesaplar = [];
        let malzemeler = [];
        let satirSayisi = 0;

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            loadCariHesaplar();
            loadMalzemeler();
            setDefaultDate();
            generateFaturaNo();
            addRow(); // İlk satırı ekle
        });

        // Varsayılan tarih
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fatura-tarih').value = today;
        }

        // Fatura numarası oluştur
        async function generateFaturaNo() {
            try {
                const response = await fetch('/api/fatura');
                const data = await response.json();
                if (data.success && data.faturalar && data.faturalar.length > 0) {
                    // Son fatura numarasını bul
                    const lastNo = data.faturalar[0].faturaNo || '';
                    const year = new Date().getFullYear();
                    let num = 1;
                    if (lastNo.includes(year.toString())) {
                        const match = lastNo.match(/\d{7}$/);
                        if (match) {
                            num = parseInt(match[0]) + 1;
                        }
                    }
                    document.getElementById('fatura-no').value = `AAA${year}${String(num).padStart(7, '0')}`;
                } else {
                    const year = new Date().getFullYear();
                    document.getElementById('fatura-no').value = `AAA${year}0000001`;
                }
            } catch (error) {
                const year = new Date().getFullYear();
                document.getElementById('fatura-no').value = `AAA${year}0000001`;
            }
        }

        // Cari hesapları yükle
        async function loadCariHesaplar() {
            try {
                const response = await fetch('/api/cari-hesap');
                const data = await response.json();
                if (data.success) {
                    cariHesaplar = data.cari_hesap || [];
                    const select = document.getElementById('cari-hesap');
                    cariHesaplar.forEach(cari => {
                        const option = document.createElement('option');
                        option.value = cari.id;
                        option.textContent = `${cari.vergiNo || ''} - ${cari.unvani || ''}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Cari hesaplar yüklenirken hata:', error);
            }
        }

        // Malzemeleri yükle
        async function loadMalzemeler() {
            try {
                const response = await fetch('/api/malzeme');
                const data = await response.json();
                if (data.success) {
                    malzemeler = data.malzemeler || [];
                    // Datalist'i doldur
                    const datalist = document.getElementById('malzeme-list');
                    datalist.innerHTML = '';
                    malzemeler.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.kod || '';
                        option.textContent = `${m.kod || ''} - ${m.ad || ''}`;
                        option.setAttribute('data-id', m.id);
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Malzemeler yüklenirken hata:', error);
            }
        }

        // Satır ekle
        function addRow() {
            const tbody = document.getElementById('satirlar-tbody');
            const row = document.createElement('tr');
            row.id = `satir-${satirSayisi}`;
            row.innerHTML = `
                <td>
                    <input type="text" class="malzeme-kodu" list="malzeme-list" 
                           onchange="onMalzemeKoduChange(${satirSayisi})" 
                           placeholder="Kod girin veya seçin..."
                           style="width: 100%; padding: 5px;">
                </td>
                <td><input type="text" class="malzeme-adi" readonly style="width: 100%; padding: 5px; background: #e9ecef;"></td>
                <td><input type="number" class="miktar" step="0.01" value="0" onchange="calculateRow(${satirSayisi})" style="width: 100%; padding: 5px;"></td>
                <td><input type="text" class="birim" readonly style="width: 100%; padding: 5px; background: #e9ecef;"></td>
                <td><input type="number" class="birim-fiyat" step="0.01" value="0" onchange="calculateRow(${satirSayisi})" style="width: 100%; padding: 5px;"></td>
                <td><input type="number" class="kdv" value="18" min="0" max="100" onchange="calculateRow(${satirSayisi})" style="width: 100%; padding: 5px;"></td>
                <td><input type="text" class="tutar" readonly style="width: 100%; padding: 5px; background: #e9ecef;"></td>
                <td><input type="text" class="net-tutar" readonly style="width: 100%; padding: 5px; background: #e9ecef;"></td>
                <td><button type="button" onclick="removeRow(${satirSayisi})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Sil</button></td>
            `;
            tbody.appendChild(row);
            satirSayisi++;
        }

        // Satır sil
        function removeRow(index) {
            const row = document.getElementById(`satir-${index}`);
            if (row) {
                row.remove();
                calculateTotals();
            }
        }

        // Malzeme kodu değiştiğinde
        function onMalzemeKoduChange(rowIndex) {
            const row = document.getElementById(`satir-${rowIndex}`);
            const kodInput = row.querySelector('.malzeme-kodu');
            const kod = kodInput.value.trim().toUpperCase();
            
            const malzeme = malzemeler.find(m => (m.kod || '').toUpperCase() === kod);
            if (malzeme) {
                row.querySelector('.malzeme-adi').value = malzeme.ad || '';
                row.querySelector('.birim').value = malzeme.birim || 'ADET';
                row.querySelector('.birim-fiyat').value = malzeme.birimFiyat || 0;
                row.querySelector('.kdv').value = malzeme.kdvOrani || 18;
                calculateRow(rowIndex);
            } else {
                row.querySelector('.malzeme-adi').value = '';
                row.querySelector('.birim').value = '';
                row.querySelector('.birim-fiyat').value = 0;
            }
        }

        // Satır hesapla
        function calculateRow(rowIndex) {
            const row = document.getElementById(`satir-${rowIndex}`);
            if (!row) return;

            const miktar = parseFloat(row.querySelector('.miktar').value) || 0;
            const birimFiyat = parseFloat(row.querySelector('.birim-fiyat').value) || 0;
            const kdv = parseFloat(row.querySelector('.kdv').value) || 0;

            const tutarKdvHaric = miktar * birimFiyat;
            const kdvTutari = tutarKdvHaric * (kdv / 100);
            const tutarKdvDahil = tutarKdvHaric + kdvTutari;

            // Tutar alanı KDV dahil gösterilecek
            row.querySelector('.tutar').value = formatCurrency(tutarKdvDahil);
            row.querySelector('.net-tutar').value = formatCurrency(tutarKdvDahil);

            calculateTotals();
        }

        // Toplamları hesapla
        function calculateTotals() {
            let araToplamKdvDahil = 0;
            let kdvToplam = 0;
            let genelToplam = 0;

            const rows = document.querySelectorAll('#satirlar-tbody tr');
            rows.forEach(row => {
                const miktar = parseFloat(row.querySelector('.miktar').value) || 0;
                const birimFiyat = parseFloat(row.querySelector('.birim-fiyat').value) || 0;
                const kdv = parseFloat(row.querySelector('.kdv').value) || 0;

                const tutarKdvHaric = miktar * birimFiyat;
                const kdvTutari = tutarKdvHaric * (kdv / 100);
                const tutarKdvDahil = tutarKdvHaric + kdvTutari;

                araToplamKdvDahil += tutarKdvDahil;
                kdvToplam += kdvTutari;
            });

            genelToplam = araToplamKdvDahil;

            // Ara Toplam artık KDV dahil tutarı gösteriyor
            document.getElementById('ara-toplam').textContent = formatCurrency(araToplamKdvDahil);
            document.getElementById('kdv-toplam').textContent = formatCurrency(kdvToplam);
            document.getElementById('genel-toplam').textContent = formatCurrency(genelToplam);
        }

        // Form gönderimi
        document.getElementById('fatura-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const cariId = document.getElementById('cari-hesap').value;
            if (!cariId) {
                NotificationSystem.error('Lütfen bir cari hesap seçiniz!', true);
                return;
            }

            // Satırları topla
            const satirlar = [];
            const rows = document.querySelectorAll('#satirlar-tbody tr');
            let hasValidRow = false;

            rows.forEach(row => {
                const miktar = parseFloat(row.querySelector('.miktar').value) || 0;
                const birimFiyat = parseFloat(row.querySelector('.birim-fiyat').value) || 0;
                const malzemeKodu = row.querySelector('.malzeme-kodu').value.trim();

                if (malzemeKodu && miktar > 0 && birimFiyat > 0) {
                    hasValidRow = true;
                    const kdv = parseFloat(row.querySelector('.kdv').value) || 0;
                    const tutarKdvHaric = miktar * birimFiyat;
                    const kdvTutari = tutarKdvHaric * (kdv / 100);
                    const tutarKdvDahil = tutarKdvHaric + kdvTutari;

                    satirlar.push({
                        malzemeKodu: malzemeKodu,
                        malzemeAdi: row.querySelector('.malzeme-adi').value,
                        miktar: miktar,
                        birim: row.querySelector('.birim').value,
                        birimFiyat: birimFiyat,
                        kdvOrani: kdv,
                        tutar: tutarKdvDahil,  // KDV dahil tutar
                        netTutar: tutarKdvDahil  // KDV dahil tutar (netTutar alan adı yanıltıcı ama backend uyumluluğu için)
                    });
                }
            });

            if (!hasValidRow) {
                NotificationSystem.error('Lütfen en az bir geçerli fatura satırı ekleyiniz!', true);
                return;
            }

            // Cari hesap bilgilerini al
            const selectedCari = cariHesaplar.find(c => c.id === cariId);
            if (!selectedCari) {
                NotificationSystem.error('Seçili cari hesap bulunamadı!', true);
                return;
            }

            const faturaData = {
                faturaNo: document.getElementById('fatura-no').value,
                tarih: document.getElementById('fatura-tarih').value,
                faturaTipi: document.getElementById('fatura-tipi').value,
                cariId: cariId,
                odemePlani: document.getElementById('odeme-plani').value,
                cariHesap: {
                    id: selectedCari.id,
                    unvani: selectedCari.unvani,
                    vergiNo: selectedCari.vergiNo,
                    email: selectedCari.email,
                    telefon: selectedCari.telefon,
                    adres: selectedCari.adres
                },
                satirlar: satirlar,
                // Tüm tutarlar KDV dahil olarak gönderiliyor
                toplam: parseFloat(document.getElementById('genel-toplam').textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0,  // KDV dahil toplam
                toplamKDV: parseFloat(document.getElementById('kdv-toplam').textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0,  // KDV tutarı
                netTutar: parseFloat(document.getElementById('genel-toplam').textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0  // KDV dahil toplam
            };

            try {
                const response = await fetch('/api/fatura', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(faturaData)
                });

                const data = await response.json();

                if (data.success) {
                    NotificationSystem.success('Fatura başarıyla oluşturuldu!', false);
                    setTimeout(() => {
                        window.location.href = '{{ url_for("main.satis_faturalari") }}';
                    }, 1500);
                } else {
                    NotificationSystem.error('Hata: ' + data.error, true);
                }
            } catch (error) {
                console.error('Hata:', error);
                NotificationSystem.error('Fatura oluşturulurken hata oluştu: ' + error.message, true);
            }
        });

        function formatCurrency(num) {
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(num);
        }
    </script>
    {% include 'includes/hesap_makinesi.html' %}
    {% include 'includes/notification.html' %}
</body>
</html>

