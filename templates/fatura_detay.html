<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatura Detayı</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cari_hesap_liste.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/input-fix.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fatura-detail-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }
        .fatura-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .fatura-info h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        .info-value {
            color: #212529;
        }
        .satirlar-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .satirlar-table th,
        .satirlar-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .satirlar-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .totals-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .action-buttons {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-action {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-pdf {
            background: #dc3545;
            color: white;
        }
        .btn-email {
            background: #28a745;
            color: white;
        }
        .btn-back {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        {% include 'includes/header.html' %}

        <main class="main-content">
            <div class="cari-modul-header">
                <h2 class="modul-title">Fatura Detayı</h2>
                <button class="btn-yeni-cari" onclick="window.location.href='{{ url_for('main.satis_faturalari') }}'">
                    <i class="fas fa-arrow-left"></i> Geri
                </button>
            </div>

            <div class="fatura-detail-container" id="fatura-detail">
                <div id="loading" class="loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Yükleniyor...
                </div>
                <div id="fatura-content">
                    <!-- Fatura bilgileri buraya yüklenecek -->
                </div>
            </div>
        </main>
    </div>

    <script>
        const faturaId = '{{ fatura_id }}';
        {% if fatura %}
        const faturaData = {{ fatura | tojson }};
        {% else %}
        const faturaData = null;
        {% endif %}

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            if (faturaData) {
                document.getElementById('loading').style.display = 'none';
                displayFaturaDetail(faturaData);
            } else {
                loadFaturaDetail();
            }
        });

        // Fatura detayını yükle (eğer template'den gelmediyse)
        async function loadFaturaDetail() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                // Önce tüm faturaları getir
                const response = await fetch('/api/fatura');
                const data = await response.json();
                
                if (data.success) {
                    const fatura = data.faturalar.find(f => f.id === faturaId);
                    if (fatura) {
                        displayFaturaDetail(fatura);
                    } else {
                        NotificationSystem.error('Fatura bulunamadı!', true);
                        setTimeout(() => {
                            window.location.href = '{{ url_for("main.satis_faturalari") }}';
                        }, 2000);
                    }
                } else {
                    NotificationSystem.error('Fatura yüklenirken hata oluştu: ' + data.error, true);
                }
            } catch (error) {
                console.error('Hata:', error);
                NotificationSystem.error('Fatura yüklenirken hata oluştu', true);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Fatura detayını göster
        function displayFaturaDetail(fatura) {
            if (!fatura) {
                document.getElementById('fatura-content').innerHTML = '<p>Fatura bulunamadı!</p>';
                return;
            }
            
            const cariHesap = fatura.cariHesap || {};
            const unvan = typeof cariHesap === 'string' ? '-' : (cariHesap.unvani || '-');
            let satirlar = fatura.satirlar || [];
            
            // Eğer satirlar string ise parse et
            if (typeof satirlar === 'string') {
                try {
                    satirlar = JSON.parse(satirlar);
                } catch {
                    satirlar = [];
                }
            }
            
            const content = `
                <div class="fatura-header">
                    <div class="fatura-info">
                        <h3>Fatura Bilgileri</h3>
                        <div class="info-row">
                            <span class="info-label">Fatura No:</span>
                            <span class="info-value">${fatura.faturaNo || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tarih:</span>
                            <span class="info-value">${fatura.tarih || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Fatura Tipi:</span>
                            <span class="info-value">${fatura.faturaTipi || '-'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Durum:</span>
                            <span class="info-value">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; 
                                    background: ${fatura.durum === 'Kesildi' ? '#28a745' : '#ffc107'}; 
                                    color: ${fatura.durum === 'Kesildi' ? 'white' : 'black'};">
                                    ${fatura.durum || 'Açık'}
                                </span>
                            </span>
                        </div>
                        ${fatura.last_modified_by_name ? `
                        <div class="info-row">
                            <span class="info-label">Son Düzenleyen:</span>
                            <span class="info-value">${fatura.last_modified_by_name || '-'}</span>
                        </div>
                        ` : ''}
                        ${fatura.updated_at ? `
                        <div class="info-row">
                            <span class="info-label">Son Düzenleme Tarihi:</span>
                            <span class="info-value">${new Date(fatura.updated_at).toLocaleString('tr-TR')}</span>
                        </div>
                        ` : ''}
                        ${fatura.created_by_name ? `
                        <div class="info-row">
                            <span class="info-label">Oluşturan:</span>
                            <span class="info-value">${fatura.created_by_name || '-'}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="fatura-info">
                        <h3>Cari Hesap Bilgileri</h3>
                        <div class="info-row">
                            <span class="info-label">Unvan:</span>
                            <span class="info-value">${unvan}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Vergi No:</span>
                            <span class="info-value">${typeof cariHesap === 'string' ? '-' : (cariHesap.vergiNo || '-')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">E-posta:</span>
                            <span class="info-value">${typeof cariHesap === 'string' ? '-' : (cariHesap.email || '-')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Telefon:</span>
                            <span class="info-value">${typeof cariHesap === 'string' ? '-' : (cariHesap.telefon || '-')}</span>
                        </div>
                    </div>
                </div>

                <h3>Fatura Satırları</h3>
                <table class="satirlar-table">
                    <thead>
                        <tr>
                            <th>Malzeme Kodu</th>
                            <th>Malzeme Adı</th>
                            <th>Miktar</th>
                            <th>Birim</th>
                            <th>Birim Fiyat</th>
                            <th>KDV %</th>
                            <th>Tutar (KDV Dahil)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${satirlar && satirlar.length > 0 ? satirlar.map(satir => `
                            <tr>
                                <td>${satir.malzemeKodu || satir.stokKodu || '-'}</td>
                                <td>${satir.malzemeAdi || satir.malzemeIsmi || '-'}</td>
                                <td>${formatNumber(satir.miktar || 0)}</td>
                                <td>${satir.birim || '-'}</td>
                                <td>${formatCurrency(satir.birimFiyat || 0)}</td>
                                <td>%${satir.kdvOrani || 0}</td>
                                <td>${formatCurrency(satir.netTutar || satir.net_tutar || ((satir.tutar || 0) + ((satir.tutar || 0) * (satir.kdvOrani || 0) / 100)))}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="7" style="text-align: center; padding: 20px;">Fatura satırı bulunamadı</td></tr>'}
                    </tbody>
                </table>

                <div class="totals-section">
                    <div class="totals-row">
                        <span>Mal / Hizmet Toplam Tutarı (KDV Dahil):</span>
                        <span>${formatCurrency(fatura.toplam || 0)}</span>
                    </div>
                    <div class="totals-row">
                        <span>Hesaplanan KDV:</span>
                        <span>${formatCurrency(fatura.toplamKDV || 0)}</span>
                    </div>
                    <div class="totals-row total">
                        <span>Ödenecek Tutar:</span>
                        <span>${formatCurrency(fatura.toplam || 0)}</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-action btn-back" onclick="window.location.href='{{ url_for('main.satis_faturalari') }}'">
                        <i class="fas fa-arrow-left"></i> Geri
                    </button>
                    <button class="btn-action btn-pdf" onclick="downloadPDF('${fatura.id}')">
                        <i class="fas fa-file-pdf"></i> PDF İndir
                    </button>
                    <button class="btn-action btn-email" onclick="sendEmail('${fatura.id}')">
                        <i class="fas fa-envelope"></i> E-posta Gönder
                    </button>
                </div>
            `;

            document.getElementById('fatura-content').innerHTML = content;
            document.getElementById('fatura-content').style.display = 'block';
        }

        // PDF indir
        async function downloadPDF(faturaId) {
            try {
                // Fatura detayını al
                const response = await fetch('/api/fatura');
                const data = await response.json();
                
                if (data.success) {
                    const fatura = data.faturalar.find(f => f.id === faturaId);
                    if (fatura) {
                        // PDF oluşturma için API endpoint'i çağır
                        const pdfResponse = await fetch(`/api/fatura/${faturaId}/pdf`, {
                            method: 'GET'
                        });
                        
                        if (pdfResponse.ok) {
                            const blob = await pdfResponse.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `Fatura_${fatura.faturaNo || faturaId}.pdf`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                        } else {
                            // PDF endpoint yoksa, fatura bilgilerini göster ve manuel PDF oluşturma öner
                            NotificationSystem.warning('PDF oluşturma özelliği yakında eklenecek. Şimdilik masaüstü uygulamasını kullanabilirsiniz.', true);
                        }
                    }
                }
            } catch (error) {
                console.error('PDF indirme hatası:', error);
                NotificationSystem.error('PDF indirilirken hata oluştu', true);
            }
        }

        // E-posta gönder
        async function sendEmail(faturaId) {
            if (!confirm('Bu faturayı e-posta ile göndermek istediğinize emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch(`/api/fatura/${faturaId}/send-email`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    NotificationSystem.success('Fatura başarıyla e-posta ile gönderildi!', false);
                } else {
                    NotificationSystem.error('Hata: ' + data.error, true);
                }
            } catch (error) {
                console.error('E-posta gönderme hatası:', error);
                NotificationSystem.error('E-posta gönderilirken hata oluştu: ' + error.message, true);
            }
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(num);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(num);
        }
    </script>
    {% include 'includes/hesap_makinesi.html' %}
    {% include 'includes/notification.html' %}
</body>
</html>

